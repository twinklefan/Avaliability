<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Availability</title>
    <link rel="manifest" href="manifest.json" />
    <link rel="shortcut icon" href="check.png" type="image/x-icon" />
    <link
      href="https://fonts.googleapis.com/css?family=Fascinate|Alef"
      rel="stylesheet"
    />
    <style>
      html {
        /* COLOURS REMOVED: #8A65E8 */
        background: linear-gradient(
          45deg,
          #e86aff,
          #658eff,
          #65cee8,
          #5df5be,
          #71d766
        );
        /* background: linear-gradient(125deg, #FFFFFF 0%, #000000 100%), linear-gradient(200deg, #FFD9E8 0%, #FFD9E8 50%, #DE95BA calc(50% + 1px), #DE95BA 60%, #7F4A88 calc(60% + 1px), #7F4A88 75%, #4A266A calc(75% + 1px), #4A266A 100%), linear-gradient(113deg, #FFD9E8 0%, #FFD9E8 40%, #DE95BA calc(40% + 1px), #DE95BA 50%, #7F4A88 calc(50% + 1px), #7F4A88 70%, #4A266A calc(70% + 1px), #4A266A 100%);
        background-blend-mode: overlay, overlay, normal; */
        background-size: 800% 800%;
        animation: background 15s ease infinite;
        -webkit-animation: background 15s ease infinite;
        -moz-animation: background 15s ease infinite;
        display: inline;
        overflow: hidden;
        height: 100%;
      }
      body {
        line-height: 1;
        font-weight: 400;
        color: #fff;
        padding: 2% 4%;
        background-color: transparent;
        margin: 0;
        background-image: -webkit-repeating-radial-gradient(
          center center,
          rgba(255, 255, 255, 0.25),
          rgba(255, 255, 255, 0.25) 2px,
          transparent 2px,
          transparent 100%
        );
        background-image: -moz-repeating-radial-gradient(
          center center,
          rgba(255, 255, 255, 0.25),
          rgba(255, 255, 255, 0.25) 2px,
          transparent 2px,
          transparent 100%
        );
        background-image: -ms-repeating-radial-gradient(
          center center,
          rgba(255, 255, 255, 0.25),
          rgba(255, 255, 255, 0.25) 2px,
          transparent 2px,
          transparent 100%
        );
        background-image: repeating-radial-gradient(
          center center,
          rgba(255, 255, 255, 0.25),
          rgba(255, 255, 255, 0.25) 2px,
          transparent 2px,
          transparent 100%
        );
        -webkit-background-size: 10px 10px;
        -moz-background-size: 10px 10px;
        background-size: 10px 10px;
        height: 100%;
      }
      h1 {
        font-family: "Fascinate";
        font-size: 9vh;
        margin: 20px 10px 20px;
        text-align: center;
      }
      h3 {
        font-size: 4vh;
        margin: 5px 0 15px 0;
        font-family: "Alef";
      }
      #enable {
        font-family: "Alef";
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(8px);
        border-radius: 15px;
        border: 0px solid white;
        margin: 0 0 40px;
        text-align: center;
        color: #ffffff;
        padding: 4px 10px;
      }
      #enable:hover {
        transition: transform 0.2s;
        background: rgba(255, 255, 255, 0.4);
      }
      label {
        font-family: "Alef";
        font-size: 3vh;
        margin: 10px;
      }
      input[type="checkbox"] {
        width: 20px;
        height: 20px;
      }
      #content {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 20px;
        text-align: center;
      }
      .sub {
        flex: 1 1 300px;
        max-width: 400px;
        max-height: 400px;
        padding: 25px;
        border-radius: 15px;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(8px);
        transition: transform 0.2s;
      }
      .sub:hover {
        transform: scale(1.02);
      }
      @media (max-width: 700px) {
        #content {
          flex-direction: column;
          align-items: center;
        }
        .sub {
          width: 90%;
          max-height: 140px;
        }
      }
      @media screen and (max-width: 768px) {
        h1 {
          font-size: 7vh;
        }
        h3 {
          font-size: 4vh;
        }
        label {
          font-size: 3vh;
        }
        input[type="checkbox"] {
          width: 50px;
          height: 50px;
        }
      }
    </style>
  </head>
  <body>
    <center>
      <h1>Availability Tracker</h1>
      <button id="enable">Enable notifications</button>
    </center>
    <div id="content">
      <div class="sub">
        <h3>Misato</h3>
        <label><input type="checkbox" id="m-t" /> Talk</label><br />
        <label><input type="checkbox" id="m-c" /> Call</label><br />
        <label><input type="checkbox" id="m-p" /> Play</label><br />
      </div>
      <div class="sub">
        <h3>Chloe</h3>
        <label><input type="checkbox" id="c-t" /> Talk</label><br />
        <label><input type="checkbox" id="c-c" /> Call</label><br />
        <label><input type="checkbox" id="c-p" /> Play</label><br />
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        onValue,
        set,
      } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

      // Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyBDQVLVHlNMtit_X2lrtNp5_nqVaY7vWY0",
        authDomain: "avaliability.firebaseapp.com",
        databaseURL:
          "https://avaliability-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "avaliability",
        storageBucket: "avaliability.firebasestorage.app",
        messagingSenderId: "163231772068",
        appId: "1:163231772068:web:291a0be7ec337e45632531",
        measurementId: "G-60WBCXVLXX",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // Notification permission
      const notificationBtn = document.getElementById("enable");
      notificationBtn.addEventListener("click", askNotificationPermission);
      function askNotificationPermission() {
        if (!("Notification" in window)) {
          alert("This browser does not support notifications.");
          return;
        }
        Notification.requestPermission().then((permission) => {
          if (permission === "granted") {
            notificationBtn.style.display = "none";
            console.log("Notifications enabled");
          } else {
            alert(
              "Notifications blocked. Enable them in your browser settings."
            );
          }
        });
      }

      function sendNotification(name, action, available) {
        if (Notification.permission === "granted") {
          const status = available
            ? "is now available for"
            : "is no longer available for";
          new Notification("Availability Update", {
            body: `${name} ${status} ${action}.`,
            icon: "check.png",
          });
        }
      }

      // Get checkboxes
      const mtBox = document.getElementById("m-t");
      const ctBox = document.getElementById("c-t");
      const mcBox = document.getElementById("m-c");
      const ccBox = document.getElementById("c-c");
      const mpBox = document.getElementById("m-p");
      const cpBox = document.getElementById("c-p");

      // Helper to setup listeners
      function bindAvailability(box, path, name, action) {
        let previousValue = null;
        onValue(ref(db, path), (snapshot) => {
          const val = snapshot.val() || false;
          box.checked = val;
          // Only notify if the value changed (and not on first load)
          if (previousValue !== null && previousValue !== val) {
            sendNotification(name, action, val);
          }
          previousValue = val;
        });

        box.addEventListener("change", () => set(ref(db, path), box.checked));
      }
      // Set up all bindings
      bindAvailability(mtBox, "availability/m-t", "Misato", "Talk");
      bindAvailability(mcBox, "availability/m-c", "Misato", "Call");
      bindAvailability(mpBox, "availability/m-p", "Misato", "Play");
      bindAvailability(ctBox, "availability/c-t", "Chloe", "Talk");
      bindAvailability(ccBox, "availability/c-c", "Chloe", "Call");
      bindAvailability(cpBox, "availability/c-p", "Chloe", "Play");

      import {
        getMessaging,
        getToken,
        onMessage,
      } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-messaging.js";

      const messaging = getMessaging(app);

      // Register the service worker at the site root and then request permission
      // and get an FCM token that is tied to that service worker registration.
      navigator.serviceWorker
        .register('/firebase-messaging-sw.js')
        .then((registration) => {
          console.log('Service Worker registered:', registration);

          // Request permission and then getToken with the SW registration
          return Notification.requestPermission().then((permission) => {
            if (permission === 'granted') {
              return getToken(messaging, {
                vapidKey:
                  'BAsspzadOkEXFR1a5I9x1NJJAEoqbnaU0PABL6I9BFOJiBOuKKXhDmlZWaPYTe1wnFt9_ElBH3CV5Lar-TiFx_M',
                serviceWorkerRegistration: registration,
              })
                .then((currentToken) => {
                  if (currentToken) {
                    console.log('FCM Token:', currentToken);
                  } else {
                    console.log('No registration token available.');
                  }
                })
                .catch((err) => console.error('Token retrieval error:', err));
            } else {
              console.log('Notification permission not granted');
            }
          });
        })
        .catch((err) => console.error('Service Worker registration failed:', err));

      onMessage(messaging, (payload) => {
        console.log("Message received:", payload);
        new Notification(payload.notification.title, {
          body: payload.notification.body,
          icon: "check.png",
        });
      });
    </script>
  </body>
</html>
